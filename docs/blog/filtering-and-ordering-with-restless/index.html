<!DOCTYPE html>
<html lang="en-us">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="chrome=1">
	<meta name="HandheldFriendly" content="True">
	<meta name="MobileOptimized" content="320">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="referrer" content="no-referrer">
    <meta name="author" content="toxinu" />
	<meta name="description" content="Developer, hacker, music listener and books reader.">

	<title>
	
	
	     Filtering and ordering with Restless 
	
	</title>
    <link rel="stylesheet" href="/css/style.css">
    

	
    <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/images/favicons/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/images/favicons/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/images/favicons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicons/favicon-16x16.png">
    <link rel="manifest" href="/images/favicons/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/images/favicons/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <script type="text/javascript" src="/js/script.js"></script>
</head>
<body>
    <div class="masthead grid">
        <div class="inline left">
            <a class="home" href="/">toxinu</a>
        </div>
        <ul class="inline right">
            <li><a href="/code">Code</a></li>
            <li><a href="/about">About</a></li>
        </ul>
    </div>

<div class="grid">
<h1>Filtering and ordering with Restless</h1>
    <span class="small">Posted on 29 December 2014</span>

    <div>

<p>Let&rsquo;s continue with my <a href="/blog/restless-for-building-python-restful-api/">previous blog post</a> on <a href="https://github.com/toastdriven/restless">Restless</a> introduction with <a href="https://www.djangoproject.com/">Django</a>.
Today I&rsquo;ll show you two quick and simple <a href="http://en.wikipedia.org/wiki/Mixin">Mixins</a> for Restless. One for <strong>filtering</strong> and another for <strong>ordering</strong>.</p>

<p>I won&rsquo;t show you how to create Django app, models, etc. This is not the subject.</p>

<p>Just to be clear, I have this <code>models.py</code> for our Pizza shop.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>


<span class="k">class</span> <span class="nc">Pizza</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">()</span>
    <span class="n">is_vegetarian</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Ingredient</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PizzaIngredient</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">pizza</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Pizza&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;ingredients&#39;</span><span class="p">)</span>
    <span class="n">ingredient</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Ingredient&#39;</span><span class="p">)</span>
</code></pre></div>


<p>And my <code>resources.py</code>:</p>

<p><div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="kn">from</span> <span class="nn">restless.dj</span> <span class="kn">import</span> <span class="n">DjangoResource</span>
<span class="kn">from</span> <span class="nn">restless.preparers</span> <span class="kn">import</span> <span class="n">FieldsPreparer</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Pizza</span>


<span class="k">class</span> <span class="nc">PizzaResource</span><span class="p">(</span><span class="n">DjangoResource</span><span class="p">):</span>
    <span class="n">preparer</span> <span class="o">=</span> <span class="n">FieldsPreparer</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;name&#39;</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Pizza</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</code></pre></div>
</p>

<h2 id="filtering">Filtering</h2>

<p>We are building a very simple and not complete <code>APIFilterMixin</code> class.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="lineno">1 </span><span class="k">class</span> <span class="nc">APIFilterMixin</span><span class="p">:</span>
<span class="lineno">2 </span>    <span class="n">allowed_fields_filter</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno">3 </span>
<span class="lineno">4 </span>    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
<span class="lineno">5 </span>        <span class="n">filters</span> <span class="o">=</span> <span class="p">{}</span>
<span class="lineno">6 </span>        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">:</span>
<span class="lineno">7 </span>            <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_fields_filter</span><span class="p">:</span>
<span class="lineno">8 </span>                <span class="n">filters</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">arg</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">arg</span><span class="p">)})</span>
<span class="lineno">9 </span><span class="hll">        <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="n">filters</span><span class="p">)</span>
</span></code></pre></div>


<p>As you can see <code>allowed_fields_filter</code> allow us to put filters (with lookup) that we want to authorize on our <code>Resource</code>.</p>

<p>This mixin only expose a single <code>filter</code> method which take one argument, a <code>QuerySet</code> instance.</p>

<p>At line 6 we just iterate over all request arguments, check if this argument is in <code>allowed_fields_filter</code>, update <code>filters</code> dictionary and at (<em>line 9</em>), we unpack filters in a <code>filter</code> method.</p>

<p>And this is updated revision of our previous <code>resources.py</code> with new mixin:</p>

<p><div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="k">class</span> <span class="nc">PizzaResource</span><span class="p">(</span><span class="n">APIFilterMixin</span><span class="p">,</span> <span class="n">DjangoResource</span><span class="p">):</span>
    <span class="n">preparer</span> <span class="o">=</span> <span class="n">FieldsPreparer</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;name&#39;</span><span class="p">})</span>
    <span class="n">allowed_fields_filter</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;name__startswith&#39;</span><span class="p">,</span>
        <span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="s1">&#39;price__lte&#39;</span><span class="p">,</span> <span class="s1">&#39;price__gte&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ingredients__ingredient__name&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">Pizza</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span>
</code></pre></div>
</p>

<p>We can now give all filters we have allowed in <code>allowed_fields_filter</code>, including relation lookups.</p>

<h2 id="ordering">Ordering</h2>

<p>Ordering is even more simple than filtering. Look how restless allow us to cleanly create our minimal <a href="http://en.wikipedia.org/wiki/Application_programming_interface">API</a>.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="lineno"> 1 </span><span class="k">class</span> <span class="nc">APIOrderingMixin</span><span class="p">:</span>
<span class="lineno"> 2 </span>    <span class="n">allowed_fields_ordering</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno"> 3 </span>    <span class="n">ordering_field</span> <span class="o">=</span> <span class="s1">&#39;order_by&#39;</span>
<span class="lineno"> 4 </span>
<span class="lineno"> 5 </span>    <span class="k">def</span> <span class="nf">ordering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
<span class="lineno"> 6 </span>        <span class="n">order_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ordering_field</span><span class="p">)</span>
<span class="lineno"> 7 </span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">order_by</span><span class="p">:</span>
<span class="lineno"> 8 </span>            <span class="k">return</span> <span class="n">queryset</span>
<span class="lineno"> 9 </span>
<span class="lineno">10 </span><span class="hll">        <span class="k">if</span> <span class="n">order_by</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_fields_ordering</span><span class="p">:</span>
</span><span class="lineno">11 </span>            <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">order_by</span><span class="p">)</span>
<span class="lineno">12 </span>
<span class="lineno">13 </span>        <span class="k">return</span> <span class="n">queryset</span>
</code></pre></div>


<p>This mixin support custom ordering field name with <code>ordering_field</code>. We can allow fields we want with <code>allowed_fields_ordering</code>.
Another simple but cool feature is reverse ordering support (<em>line 10</em>).</p>

<p>Just add <code>APIOrderingMixin</code> to your <code>PizzaResource</code> and here we go.</p>

<p>Happy programming everybody!</p>
</div>
</div>
	<div class="footer grid ta">
		&copy; 2017 toxinu <small class="latest-update">(latest update at 2017-10-11 13:45:49 &#43;0200 CEST)</small>
	</div>
	<script data-no-instant>InstantClick.init();</script>
</body>
</html>

